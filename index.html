<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HammerCurs.io</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; overflow: hidden; background: #050505; font-family: 'Orbitron', sans-serif; color: white; }

        #bg-canvas { position: absolute; top: 0; left: 0; z-index: 1; opacity: 0.4; pointer-events: none; }
        
        #lobby-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .logo {
            font-size: 80px; font-weight: 900; letter-spacing: 5px;
            background: linear-gradient(180deg, #fff 10%, #ffcc00 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 30px rgba(255, 204, 0, 0.4)); margin-bottom: 40px;
            animation: float 4s ease-in-out infinite; text-transform: uppercase;
        }
        .input-box {
            background: rgba(0,0,0,0.85); border: 1px solid rgba(255,204,0,0.2); border-radius: 12px;
            padding: 50px; width: 450px; text-align: center; box-shadow: 0 0 100px rgba(0,0,0,0.9);
            position: relative; overflow: hidden;
        }
        .input-box::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #ffcc00; box-shadow: 0 0 15px #ffcc00; }

        input {
            background: transparent; border: none; border-bottom: 2px solid #444;
            color: #ffcc00; font-size: 24px; font-family: 'Orbitron'; width: 100%; text-align: center; 
            padding: 15px; margin-bottom: 30px; transition: 0.3s;
        }
        input:focus { border-color: #ffcc00; box-shadow: 0 10px 20px -10px rgba(255,204,0,0.1); }

        .play-btn {
            background: linear-gradient(135deg, #ffcc00, #ff9900); color: #000; border: none; width: 100%; padding: 20px;
            font-size: 26px; font-weight: 900; cursor: pointer; letter-spacing: 2px;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            transition: 0.2s;
        }
        .play-btn:hover { transform: scale(1.02); filter: brightness(1.2); }
        
        #ui-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .hud-top { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; align-items: flex-end; gap: 50px; }
        .stat-card {
            background: rgba(0,0,0,0.6); padding: 10px 30px; border-bottom: 4px solid #ffcc00;
            transform: skewX(-15deg); text-align: center; border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-content { transform: skewX(15deg); }
        .stat-val { font-size: 28px; font-weight: bold; color: white; display: block; }
        #timer-box { font-size: 56px; color: #ffcc00; font-weight: 900; text-shadow: 0 0 20px rgba(255,204,0,0.6); min-width: 180px; text-align: center; }

        #leaderboard {
            position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.7); 
            padding: 15px; border-radius: 8px; border: 1px solid #333; min-width: 250px;
        }
        .lb-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .lb-score { color: #ffcc00; font-weight: bold; }

        #center-msg {
            position: absolute; top: 30%; width: 100%; text-align: center;
            font-size: 32px; color: rgba(255,255,255,0.8); letter-spacing: 4px; text-shadow: 0 0 20px #000;
        }

        #loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:30; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top-color: #ffcc00; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes float { 0%,100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        canvas { display: block; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="lobby-screen">
        <div class="logo">HammerCurs.io</div>
        <div class="input-box">
            <input type="text" id="nickname" placeholder="AGENT NAME" maxlength="12">
            <button class="play-btn" onclick="startMatchmaking()">BATTLE START</button>
            <div class="status-text" style="color:#666; margin-top:15px;">ONLINE: <span id="total-online">0</span></div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="color:#ffcc00; letter-spacing: 2px;">SCANNING SECTOR...</div>
    </div>

    <div id="ui-layer">
        <div class="hud-top">
            <div class="stat-card"><div class="stat-content"><span class="stat-val" id="ui-score">0</span><span style="font-size:10px; color:#ffcc00;">SCORE</span></div></div>
            <div id="timer-box">WAIT</div>
            <div class="stat-card"><div class="stat-content"><span class="stat-val" id="ui-kills">0</span><span style="font-size:10px; color:#ffcc00;">KILLS</span></div></div>
        </div>
        <div id="leaderboard"><h3>TOP AGENTS</h3><div id="lb-list"></div></div>
        <div id="center-msg">WAITING FOR PLAYERS...</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        /* ================= CONFIG ================= */
        const CONFIG = {
            MAP_SIZE: 3000,
            PLAYER_SPEED: 7,
            MIN_PLAYERS: 2, // Ставь 1 для теста
            BATTLE_TIME: 300,
            HUNTER_TIME_LIMIT: 30, // 30 секунд на молот!
            INTERPOLATION: 0.15
        };

        const _k = {
            a: "QUl6YVN5QV80a1pkLUFTRVhBQXEtR2NrYzJqeTZsaWpQTFF6S20w",
            b: "aGFtbWVyY3Vycy1pby5maXJlYmFzZWFwcC5jb20=",
            c: "aHR0cHM6Ly9oYW1tZXJjdXJzLWlvLWRlZmF1bHQtcnRkYi5ldXJvcGUtd2VzdDEuZmlyZWJhc2VkYXRhYmFzZS5hcHA=",
            d: "aGFtbWVyY3Vycy1pbw==", 
            e: "aGFtbWVyY3Vycy1pby5maXJlYmFzZXN0b3JhZ2UuYXBw",
            f: "MTA1MTg5OTk2MDk3Mw==", 
            g: "MToxMDUxODk5OTYwOTczOndlYjoxNDIzNTg1YTFhMjFkN2ZmMTMwY2M0"
        };
        const _d = s => atob(s);
        firebase.initializeApp({ apiKey: _d(_k.a), authDomain: _d(_k.b), databaseURL: _d(_k.c), projectId: _d(_k.d), storageBucket: _d(_k.e), messagingSenderId: _d(_k.f), appId: _d(_k.g) });
        const db = firebase.database();
        const auth = firebase.auth();

        let myId, myNick, selectedRoom, gameActive = false, battleState = "waiting";
        let players = {}, smoothPlayers = {}, coins = [], mouse = {x:0, y:0}, me = {x:0, y:0, angle:0}, cam = {x:0, y:0}, shake=0;

        // Sync Online
        db.ref('rooms').on('value', s => {
            let t = 0; let d = s.val();
            if(d) Object.values(d).forEach(r => { if(r.players) t += Object.keys(r.players).length; });
            document.getElementById('total-online').innerText = t;
        });

        async function startMatchmaking() {
            myNick = document.getElementById('nickname').value.trim() || "Agent";
            document.getElementById('loading-overlay').style.display = 'flex';
            let i = 1; let found = false;
            while(!found) {
                let path = `arena_${i}`;
                const snap = await db.ref(`rooms/${path}`).get();
                const d = snap.val();
                if(!d || (!d.battleStarted && Object.keys(d.players||{}).length < 15)) { selectedRoom = path; found = true; }
                else i++;
            }
            auth.signInAnonymously().then(() => {
                document.getElementById('loading-overlay').style.display='none';
                document.getElementById('lobby-screen').style.display='none';
                document.getElementById('ui-layer').style.display='block';
                startGame();
            });
        }

        function startGame() {
            myId = auth.currentUser.uid;
            gameActive = true;
            resize();
            me.x = Math.random()*CONFIG.MAP_SIZE; me.y = Math.random()*CONFIG.MAP_SIZE;
            const ref = db.ref(`rooms/${selectedRoom}/players/${myId}`);
            ref.set({x:me.x, y:me.y, angle:0, pts:0, kills:0, nick:myNick, isHunter:false, hunterTimer: CONFIG.HUNTER_TIME_LIMIT});
            ref.onDisconnect().remove();

            db.ref(`rooms/${selectedRoom}/players`).on('value', s => {
                players = s.val() || {};
                if(!players[myId]) location.reload();
                document.getElementById('ui-score').innerText = players[myId].pts;
                document.getElementById('ui-kills').innerText = players[myId].kills;
                me.isHunter = players[myId].isHunter;
                updateLeaderboard();
                if(isHost()) checkLogic();
            });

            db.ref(`rooms/${selectedRoom}`).on('value', s => {
                const r = s.val() || {};
                document.getElementById('timer-box').innerText = r.timer || "HOLD";
                battleState = r.battleStarted ? "battle" : (r.countdownStarted ? "countdown" : "waiting");
                let msg = document.getElementById('center-msg');
                if(battleState === "waiting") msg.innerHTML = `WAITING... ${Object.keys(players).length}/${CONFIG.MIN_PLAYERS}`;
                else if(battleState === "countdown") msg.innerText = "PREPARE!";
                else msg.style.display = 'none';
            });

            window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
            setInterval(() => { if(gameActive) db.ref(`rooms/${selectedRoom}/players/${myId}`).update({x:me.x, y:me.y, angle:me.angle}); }, 70);
            requestAnimationFrame(loop);
        }

        function isHost() { return Object.keys(players)[0] === myId; }

        function checkLogic() {
            const pCount = Object.keys(players).length;
            if(battleState === 'waiting' && pCount >= CONFIG.MIN_PLAYERS) {
                db.ref(`rooms/${selectedRoom}`).update({countdownStarted: true});
                runTimer(10, () => {
                    db.ref(`rooms/${selectedRoom}`).update({battleStarted: true, countdownStarted: false});
                    assignHunter();
                    runTimer(CONFIG.BATTLE_TIME, () => location.reload());
                });
            }
            // Hunter timeout logic
            for(let id in players) {
                if(players[id].isHunter && players[id].hunterTimer <= 0) {
                    transferHammer(id);
                }
            }
        }

        function runTimer(sec, cb) {
            let left = sec;
            let iv = setInterval(() => {
                left--;
                let m = Math.floor(left/60), s = left%60;
                db.ref(`rooms/${selectedRoom}/timer`).set(`${m}:${s<10?'0'+s:s}`);
                // Если сейчас идет битва, уменьшаем таймер хантера
                if(battleState === "battle") {
                    for(let id in players) {
                        if(players[id].isHunter) {
                            db.ref(`rooms/${selectedRoom}/players/${id}/hunterTimer`).transaction(t => (t||0)-1);
                        }
                    }
                }
                if(left <= 0) { clearInterval(iv); cb(); }
            }, 1000);
        }

        function assignHunter() {
            const ids = Object.keys(players);
            const lucky = ids[Math.floor(Math.random()*ids.length)];
            db.ref(`rooms/${selectedRoom}/players/${lucky}`).update({isHunter: true, hunterTimer: CONFIG.HUNTER_TIME_LIMIT});
        }

        function transferHammer(oldId) {
            db.ref(`rooms/${selectedRoom}/players/${oldId}`).update({isHunter: false, hunterTimer: CONFIG.HUNTER_TIME_LIMIT});
            const ids = Object.keys(players).filter(id => id !== oldId);
            if(ids.length > 0) {
                const next = ids[Math.floor(Math.random()*ids.length)];
                db.ref(`rooms/${selectedRoom}/players/${next}`).update({isHunter: true, hunterTimer: CONFIG.HUNTER_TIME_LIMIT});
            }
        }

        function lerp(a, b, t) { return a + (b - a) * t; }

        function loop() {
            if(!gameActive) return;
            let dx = mouse.x - canvas.width/2, dy = mouse.y - canvas.height/2;
            let d = Math.hypot(dx, dy);
            if(d > 20) { me.x += (dx/d)*CONFIG.PLAYER_SPEED; me.y += (dy/d)*CONFIG.PLAYER_SPEED; }
            me.x = Math.max(0, Math.min(CONFIG.MAP_SIZE, me.x)); me.y = Math.max(0, Math.min(CONFIG.MAP_SIZE, me.y));
            cam.x = lerp(cam.x, me.x - canvas.width/2, 0.1); cam.y = lerp(cam.y, me.y - canvas.height/2, 0.1);
            if(shake > 0) shake *= 0.9; me.angle += 0.15;

            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save(); ctx.translate(-cam.x + (Math.random()-0.5)*shake, -cam.y + (Math.random()-0.5)*shake);
            
            // Grid
            ctx.strokeStyle = '#111'; ctx.beginPath();
            for(let i=0; i<=MAP_SIZE; i+=100){ctx.moveTo(i,0);ctx.lineTo(i,MAP_SIZE);ctx.moveTo(0,i);ctx.lineTo(MAP_SIZE,i);} ctx.stroke();

            for(let id in players) {
                let p = players[id];
                if(!smoothPlayers[id]) smoothPlayers[id] = {x:p.x, y:p.y};
                smoothPlayers[id].x = lerp(smoothPlayers[id].x, p.x, CONFIG.INTERPOLATION);
                smoothPlayers[id].y = lerp(smoothPlayers[id].y, p.y, CONFIG.INTERPOLATION);
                let rx = id===myId?me.x:smoothPlayers[id].x;
                let ry = id===myId?me.y:smoothPlayers[id].y;

                ctx.fillStyle = id===myId?'#00eaff':(p.isHunter?'#ff3333':'#fff');
                ctx.beginPath(); ctx.arc(rx, ry, 25, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle='#fff'; ctx.font="bold 12px Orbitron"; ctx.textAlign="center"; ctx.fillText(p.nick, rx, ry-45);

                if(p.isHunter) {
                    // Таймер над хантером
                    ctx.fillStyle = '#ffcc00'; ctx.fillText(`TIME: ${p.hunterTimer}s`, rx, ry - 65);
                    
                    let da = id===myId?me.angle:p.angle;
                    let hx = rx + Math.cos(da)*90, hy = ry + Math.sin(da)*90;
                    
                    // Эффект молота
                    ctx.shadowBlur = 25; ctx.shadowColor = '#ffcc00';
                    ctx.strokeStyle='#444'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(rx,ry); ctx.lineTo(hx,hy); ctx.stroke();
                    ctx.fillStyle='#ffcc00'; ctx.fillRect(hx-20, hy-20, 40, 40);
                    ctx.shadowBlur = 0;

                    if(id===myId) {
                        for(let t in players) {
                            if(t!==myId && Math.hypot(hx-smoothPlayers[t].x, hy-smoothPlayers[t].y)<50) {
                                shake=20; db.ref(`rooms/${selectedRoom}/players/${myId}/pts`).transaction(v=>(v||0)+50);
                                db.ref(`rooms/${selectedRoom}/players/${myId}/kills`).transaction(v=>(v||0)+1);
                                db.ref(`rooms/${selectedRoom}/players/${myId}/hunterTimer`).set(CONFIG.HUNTER_TIME_LIMIT); // Сброс таймера при килле!
                                db.ref(`rooms/${selectedRoom}/players/${t}`).remove();
                            }
                        }
                    }
                }
            }
            ctx.restore(); requestAnimationFrame(loop);
        }

        function updateLeaderboard() {
            let s = Object.values(players).sort((a,b)=>b.pts-a.pts).slice(0,5);
            let h = ""; s.forEach(p => h+=`<div class="lb-row"><span>${p.nick}</span><span class="lb-score">${p.pts}</span></div>`);
            document.getElementById('lb-list').innerHTML = h;
        }
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        
        // Debug Tools
        window.dbg = {
            beHunter: () => db.ref(`rooms/${selectedRoom}/players/${myId}`).update({isHunter: true, hunterTimer: 999}),
            skipWait: () => db.ref(`rooms/${selectedRoom}`).update({countdownStarted: true, battleStarted: true})
        };
    </script>
</body>
</html>
