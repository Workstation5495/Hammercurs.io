<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HammerCurs.io - Curse of the Hammer</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Arial Black', sans-serif; color: white; user-select: none; }
        
        /* LOBBY SCREEN */
        #lobby-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
        }
        
        /* Logo Styling */
        .logo-container { display: flex; align-items: center; margin-bottom: 20px; }
        .logo-text { font-size: 60px; color: #ffcc00; text-shadow: 0 0 20px #ff6600; margin-left: 15px; }
        .logo-svg { width: 60px; height: 60px; fill: #ffcc00; filter: drop-shadow(0 0 10px #ff6600); }

        .io-btn {
            background: #ffcc00; border: none; border-bottom: 8px solid #cc9900;
            border-radius: 40px; padding: 20px 80px; font-size: 35px;
            font-family: inherit; cursor: pointer; transition: 0.1s;
            box-shadow: 0 10px 30px rgba(255, 204, 0, 0.3);
            color: #222;
        }
        .io-btn:active { transform: translateY(8px); border-bottom: 0; }
        
        /* GAME UI */
        #ui-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #top-bar {
            display: flex; justify-content: space-between; padding: 20px;
            font-size: 24px; text-shadow: 2px 2px 0 #000; align-items: center;
        }
        
        .stat-box { display: flex; align-items: center; gap: 10px; }
        .icon-svg { width: 24px; height: 24px; fill: white; }

        #timer-box { font-size: 40px; color: white; font-variant-numeric: tabular-nums; }
        .timer-panic { color: #ff3333 !important; animation: shake 0.5s infinite; font-size: 50px !important; }
        
        #message-area {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-size: 50px; color: #ff3333; text-shadow: 0 0 20px black;
            display: none; animation: popIn 0.5s;
        }

        /* ANIMATIONS */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-3px, 0px) rotate(5deg); }
            100% { transform: translate(1px, -1px) rotate(-1deg); }
        }
        @keyframes popIn {
            0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); }
        }
        
        canvas { display: block; }
    </style>
</head>
<body>

    <svg style="display: none;">
        <symbol id="icon-hammer" viewBox="0 0 24 24">
            <path d="M10 2v2h4V2H10zm-6 5v6h20V7H4zm2 8v7h4v-7H6zm8 0v7h4v-7h-4z"/>
        </symbol>
        <symbol id="icon-skull" viewBox="0 0 24 24">
            <path d="M12 2c-4.42 0-8 3.58-8 8 0 2.76 1.4 5.18 3.56 6.56L7 19v3h10v-3l-.56-2.44C18.6 15.18 20 12.76 20 10c0-4.42-3.58-8-8-8zm0 2c3.31 0 6 2.69 6 6 0 2.23-1.26 4.15-3.13 5.13L14 17h-4l-.87-1.87C7.26 14.15 6 12.23 6 10c0-3.31 2.69-6 6-6zm-3 4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm6 0c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/>
        </symbol>
        <symbol id="icon-trophy" viewBox="0 0 24 24">
            <path d="M20.2 2H3.8C2.8 2 2 2.8 2 3.8V6c0 3 2.2 5.5 5 5.9V13c0 2.6 1.9 4.8 4.4 5.3L10 20v2h4v-2l-1.4-1.7c2.5-.5 4.4-2.7 4.4-5.3v-1.1c2.8-.4 5-2.9 5-5.9V3.8c0-1-.8-1.8-1.8-1.8zM7 10c-1.7 0-3-1.3-3-3V4h3v6zm10 0c-1.7 0-3-1.3-3-3V4h3v6z"/>
        </symbol>
    </svg>

    <div id="lobby-screen">
        <div class="logo-container">
            <svg class="logo-svg"><use href="#icon-hammer"></use></svg>
            <div class="logo-text">HammerCurs.io</div>
        </div>
        <p style="color: #aaa; margin-bottom: 30px; font-size: 18px;">SURVIVE 5 MINUTES OR CRUSH THEM ALL</p>
        <button class="io-btn" onclick="startGame()">PLAY</button>
        <p id="status-text" style="margin-top: 20px; font-size: 14px; color: #666;">Waiting for player...</p>
    </div>

    <div id="ui-layer">
        <div id="top-bar">
            <div class="stat-box">
                <svg class="icon-svg"><use href="#icon-trophy"></use></svg>
                <span id="score-val">0</span> PTS
            </div>
            
            <div id="timer-box">WAITING...</div>
            
            <div class="stat-box">
                <svg class="icon-svg"><use href="#icon-skull"></use></svg>
                <span id="kill-val">0</span> KILLS
            </div>
        </div>
        <div id="message-area">NEW HAMMER!</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- 1. KEY DECODING (Base64) ---
        const _sec = {
            k: "QUl6YVN5QV80a1pkLUFTRVhBQXEtR2NrYzJqeTZsaWpQTFF6S20w",
            d: "aGFtbWVyY3Vycy1pby5maXJlYmFzZWFwcC5jb20=",
            db: "aHR0cHM6Ly9oYW1tZXJjdXJzLWlvLWRlZmF1bHQtcnRkYi5ldXJvcGUtd2VzdDEuZmlyZWJhc2VkYXRhYmFzZS5hcHA=",
            p: "aGFtbWVyY3Vycy1pbw==",
            s: "aGFtbWVyY3Vycy1pby5maXJlYmFzZXN0b3JhZ2UuYXBw",
            m: "MTA1MTg5OTk2MDk3Mw==",
            a: "MToxMDUxODk5OTYwOTczOndlYjoxNDIzNTg1YTFhMjFkN2ZmMTMwY2M0"
        };
        const _d = (s) => atob(s);

        const firebaseConfig = {
            apiKey: _d(_sec.k), authDomain: _d(_sec.d), databaseURL: _d(_sec.db),
            projectId: _d(_sec.p), storageBucket: _d(_sec.s), messagingSenderId: _d(_sec.m), appId: _d(_sec.a)
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- 2. GAME VARIABLES ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let myId = null;
        let myPlayer = { x: 0, y: 0, pts: 0, kills: 0, angle: 0 };
        let players = {};
        let coins = [];
        let camera = { x: 0, y: 0 };
        let mouse = { x: 0, y: 0 };
        let roomId = "public_arena_1"; 
        let gameActive = false;
        
        // Settings
        const MAP_SIZE = 3000;
        const HAMMER_LEN = 90;
        const HAMMER_SIZE = 40;

        // --- 3. START GAME ---
        function startGame() {
            document.getElementById('status-text').innerText = "Logging in anonymously...";
            auth.signInAnonymously().catch(e => alert(e.message));
        }

        auth.onAuthStateChanged(user => {
            if (user && !gameActive) {
                myId = user.uid;
                initGame();
            }
        });

        function initGame() {
            document.getElementById('lobby-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            gameActive = true;
            resize();

            // Create Player in DB
            const startX = Math.random() * MAP_SIZE;
            const startY = Math.random() * MAP_SIZE;
            
            db.ref(`rooms/${roomId}/players/${myId}`).set({
                x: startX, y: startY,
                pts: 0, kills: 0,
                isHunter: false, 
                nick: "Player " + Math.floor(Math.random()*1000)
            });

            // Listen to Players
            db.ref(`rooms/${roomId}/players`).on('value', snap => {
                players = snap.val() || {};
                
                // Am I alive?
                if (!players[myId]) {
                    if (gameActive) looseGame(); 
                } else {
                    // Update local stats
                    document.getElementById('score-val').innerText = players[myId].pts;
                    document.getElementById('kill-val').innerText = players[myId].kills || 0;
                    
                    // Am I the Hunter?
                    myPlayer.isHunter = players[myId].isHunter;
                }
            });

            // Listen to Coins
            db.ref(`rooms/${roomId}/coins`).on('value', snap => {
                coins = snap.val() || [];
                if (coins.length < 50 && myPlayer.isHunter) spawnCoins(); 
            });
            
            // Start Loop
            requestAnimationFrame(gameLoop);
            
            // Send Data (15 fps)
            setInterval(sendData, 70);
            
            // Timer Logic
            startClientTimer();
        }

        // --- 4. GAME LOOP & PHYSICS ---
        function gameLoop() {
            if (!gameActive) return;
            updatePhysics();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // HELICOPTER PHYSICS
        let hammerRotation = 0;
        let hammerInertia = 0;

        function updatePhysics() {
            // Movement
            let dx = mouse.x - canvas.width / 2;
            let dy = mouse.y - canvas.height / 2;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            let speed = 5;
            let vx = (dx / dist) * speed;
            let vy = (dy / dist) * speed;

            if (dist > 10) {
                myPlayer.x += vx;
                myPlayer.y += vy;
            }

            // Map Limits
            myPlayer.x = Math.max(0, Math.min(MAP_SIZE, myPlayer.x));
            myPlayer.y = Math.max(0, Math.min(MAP_SIZE, myPlayer.y));

            // Camera
            camera.x = myPlayer.x - canvas.width / 2;
            camera.y = myPlayer.y - canvas.height / 2;

            // INERTIA CALCULATION
            let moveFactor = (Math.abs(vx) + Math.abs(vy)) * 0.02;
            hammerInertia += (moveFactor - hammerInertia) * 0.1;
            hammerRotation += (0.15 + hammerInertia);

            // Collect Coins
            coins.forEach((c, index) => {
                if (!c) return;
                let cDx = myPlayer.x - c.x;
                let cDy = myPlayer.y - c.y;
                if (Math.sqrt(cDx*cDx + cDy*cDy) < 30) {
                    takeCoin(index);
                }
            });

            // ATTACK (If Hunter)
            if (myPlayer.isHunter) {
                let hX = myPlayer.x + Math.cos(hammerRotation) * HAMMER_LEN;
                let hY = myPlayer.y + Math.sin(hammerRotation) * HAMMER_LEN;

                for (let pid in players) {
                    if (pid === myId) continue;
                    let enemy = players[pid];
                    let dist = Math.sqrt((hX - enemy.x)**2 + (hY - enemy.y)**2);
                    
                    if (dist < (HAMMER_SIZE + 20)) { 
                        smashEnemy(pid);
                    }
                }
            }
        }

        function draw() {
            // Background
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grid
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = -camera.x % 100; x < canvas.width; x += 100) {
                ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
            }
            for (let y = -camera.y % 100; y < canvas.height; y += 100) {
                ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
            }
            ctx.stroke();

            ctx.save();
            ctx.translate(-camera.x, -camera.y);

            // Coins
            ctx.fillStyle = 'gold';
            coins.forEach(c => {
                if(!c) return;
                ctx.beginPath(); ctx.arc(c.x, c.y, 10, 0, Math.PI*2); ctx.fill();
            });

            // Players
            for (let pid in players) {
                let p = players[pid];
                let isMe = (pid === myId);
                
                // Body
                ctx.fillStyle = p.isHunter ? '#ff3333' : (isMe ? '#0074D9' : '#ffffff');
                if (p.isHunter) {
                    ctx.shadowBlur = 20; ctx.shadowColor = 'red';
                } else {
                    ctx.shadowBlur = 0;
                }
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, 25, 0, Math.PI*2);
                ctx.fill();

                // Score Text
                ctx.fillStyle = 'white';
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(p.pts + " PTS", p.x, p.y - 40);

                // HAMMER RENDER
                if (p.isHunter) {
                    let angle = isMe ? hammerRotation : p.angle; 
                    let hX = p.x + Math.cos(angle) * HAMMER_LEN;
                    let hY = p.y + Math.sin(angle) * HAMMER_LEN;

                    // Handle
                    ctx.strokeStyle = '#5d4037';
                    ctx.lineWidth = 8;
                    ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(hX, hY); ctx.stroke();

                    // Hammer Head
                    ctx.fillStyle = '#444';
                    ctx.save();
                    ctx.translate(hX, hY);
                    ctx.rotate(angle);
                    ctx.fillRect(-15, -25, 50, 50); 
                    // Metallic Shine
                    ctx.fillStyle = '#666';
                    ctx.fillRect(-5, -15, 30, 30);
                    ctx.restore();
                }
            }
            ctx.restore();
        }

        // --- 5. NETWORK & SCORING ---

        function sendData() {
            if (!myId) return;
            db.ref(`rooms/${roomId}/players/${myId}`).update({
                x: myPlayer.x,
                y: myPlayer.y,
                angle: hammerRotation 
            });
        }

        function takeCoin(index) {
            delete coins[index]; 
            db.ref(`rooms/${roomId}/coins/${index}`).remove();
            
            // +5 PTS
            db.ref(`players/${myId}/pts`).transaction(pts => (pts || 0) + 5);
        }

        // KILL LOGIC (+50 PTS)
        function smashEnemy(enemyId) {
            console.log("SMASHED:", enemyId);
            
            // Hunter Bonus
            db.ref(`players/${myId}/pts`).transaction(p => (p || 0) + 50);
            db.ref(`players/${myId}/kills`).transaction(k => (k || 0) + 1);

            // Victim Penalty (-300 PTS)
            db.ref(`players/${enemyId}/pts`).transaction(p => {
                let res = (p || 0) - 300;
                return res < 0 ? 0 : res; 
            });
            
            // Remove Victim
            db.ref(`rooms/${roomId}/players/${enemyId}`).remove();
            
            // Screen Shake Effect
            canvas.style.transform = "translate(5px, 5px)";
            setTimeout(() => canvas.style.transform = "none", 100);
        }

        // DEATH LOGIC
        function looseGame() {
            gameActive = false;
            alert("SMASHED! -300 PTS");
            location.reload(); 
        }
        
        // --- 6. HELPERS ---
        
        function spawnCoins() {
            let newCoins = {};
            for(let i=0; i<50; i++) {
                newCoins[i] = { x: Math.random()*MAP_SIZE, y: Math.random()*MAP_SIZE };
            }
            db.ref(`rooms/${roomId}/coins`).update(newCoins);
        }

        function startClientTimer() {
            let time = 300; // 5 minutes
            setInterval(() => {
                time--;
                let min = Math.floor(time / 60);
                let sec = time % 60;
                let timerEl = document.getElementById('timer-box');
                timerEl.innerText = `${min}:${sec < 10 ? '0'+sec : sec}`;

                // PANIC MODE (Last 10s)
                if (time < 10 && time > 0) timerEl.classList.add('timer-panic');
                
                // SURVIVAL BONUS (+400 PTS)
                if (time <= 0) {
                    if (gameActive) {
                        alert("SURVIVOR! +400 PTS!");
                        db.ref(`players/${myId}/pts`).transaction(p => (p || 0) + 400);
                        location.reload();
                    }
                }
            }, 1000);
        }

        // Controls
        window.addEventListener('mousemove', e => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });
        window.addEventListener('resize', resize);
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // Temporary Hunter Assignment (First player gets hammer after 5s)
        setTimeout(() => {
           db.ref(`rooms/${roomId}/players`).once('value', snap => {
               let all = snap.val();
               if (!all) return;
               let ids = Object.keys(all);
               if (ids.length > 0 && ids[0] === myId) {
                   db.ref(`rooms/${roomId}/players/${myId}`).update({isHunter: true});
               }
           });
        }, 5000);

    </script>
</body>
</html>
